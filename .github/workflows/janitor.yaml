name: janitor

on: [workflow_dispatch]

jobs:
  undelegated-hosted-zones:
    runs-on: ubuntu-20.04
    name: Finds entries in a hosted zone that haven't been delegated

    steps:
      - name: Send Slack Message
        uses: archive/github-actions-slack@master
        id: send-message
        with:
          slack-function: send-message
          slack-bot-user-oauth-access-token: ${{ secrets.SLACK_BOT_TOKEN }}
          slack-channel: C0197JME6QH
          slack-text: Running a job to find undelegated hosted zones for oslo.systems

      - name: Undelegated HostedZones
        uses: ./.github/actions/janitor
        id: undelegated
        with:
          command: hostedzone undelegated --hosted-zone-id ${{ secrets.AWS_OSLO_SYSTEMS_HOSTEDZONE_ID }}
        env:
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_ORIGO_PROD_JANITOR_SECRET_ACCESS_KEY }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ORIGO_PROD_JANITOR_ACCESS_KEY_ID }}

      - name: Send Thread Message
        uses: archive/github-actions-slack@master
        with:
          slack-function: send-message
          slack-bot-user-oauth-access-token: ${{ secrets.SLACK_BOT_USER_OAUTH_ACCESS_TOKEN }}
          slack-channel: ${{ fromJson(steps.send-message.outputs.slack-result).response.channel }}
          slack-text: ${{ steps.undelegated.outputs.result }}
          slack-optional-thread_ts: ${{ fromJson(steps.send-message.outputs.slack-result).response.message.ts }}
